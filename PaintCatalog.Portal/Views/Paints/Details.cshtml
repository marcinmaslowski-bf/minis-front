@using System.Collections.Generic
@using System.Linq
@using System.Text.Json
@using System.Text.Encodings.Web
@model PaintCatalog.Portal.Models.PaintDetailsViewModel
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer
@inject Microsoft.AspNetCore.Mvc.Localization.IHtmlLocalizerFactory LocalizerFactory

@{
    ViewData["Title"] = Localizer["Page_Title"].Value;
    ViewData["MetaDescription"] = Localizer["Page_Description"].Value;

    var detailsJson = string.IsNullOrWhiteSpace(Model.PaintJson) ? "null" : Model.PaintJson;
    var searchLocalizer = LocalizerFactory.Create("Views.Paints.Index", typeof(Program).Assembly.GetName().Name);
    var typeLabels = Enumerable.Range(1, 10)
        .ToDictionary(i => i.ToString(), i => searchLocalizer[$"Filters_Type_{i}"].Value);

    var finishLabels = Enumerable.Range(1, 6)
        .ToDictionary(i => i.ToString(), i => searchLocalizer[$"Filters_Finish_{i}"].Value);

    var mediumLabels = new Dictionary<string, string>
    {
        ["1"] = searchLocalizer["Filters_Medium_1"].Value,
        ["2"] = searchLocalizer["Filters_Medium_2"].Value,
        ["3"] = searchLocalizer["Filters_Medium_3"].Value,
        ["4"] = searchLocalizer["Filters_Medium_4"].Value,
        ["5"] = searchLocalizer["Filters_Medium_5"].Value,
        ["99"] = searchLocalizer["Filters_Medium_99"].Value
    };
    var jsonOptions = new JsonSerializerOptions
    {
        Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping
    };

    var bootstrap = new
    {
        paint = Model.PaintJson,
        brandSlug = Model.BrandSlug,
        seriesSlug = Model.SeriesSlug,
        paintSlug = Model.PaintSlug,
        enumLabels = new
        {
            type = typeLabels,
            finish = finishLabels,
            medium = mediumLabels
        }
    };

    var bootstrapJson = JsonSerializer.Serialize(bootstrap, jsonOptions);
    var backToSearchUrl = Url.LocalizedAction("Index", "Paints");
}

<section class="space-y-8">
    <div class="flex items-center justify-between gap-4">
        <div>
            <p class="text-xs uppercase tracking-wide text-emerald-400">@Localizer["Details_Breadcrumb"]</p>
            <h1 class="text-3xl font-extrabold text-slate-900 dark:text-white">@Localizer["Details_Title"]</h1>
            <p class="mt-1 text-sm text-slate-500 dark:text-slate-300">@Localizer["Details_Subtitle"]</p>
        </div>
        <a href="@backToSearchUrl" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-600 transition hover:border-emerald-400 hover:text-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 dark:border-slate-700 dark:text-slate-200 dark:hover:border-emerald-500 dark:hover:text-emerald-300">
            <span aria-hidden="true">←</span>
            <span>@Localizer["Details_Back"]</span>
        </a>
    </div>

    <div id="paint-details" class="rounded-2xl border border-slate-200 bg-white/90 p-6 shadow-sm dark:border-slate-800 dark:bg-slate-900/80">
        <div class="flex flex-wrap items-start gap-6">
            <div class="flex-1 space-y-3 min-w-[16rem]">
                <p class="text-xs uppercase tracking-wide text-slate-400" id="paint-brand"></p>
                <h2 class="text-2xl font-bold text-slate-900 dark:text-white" id="paint-name"></h2>
                <p class="text-sm text-slate-500 dark:text-slate-300" id="paint-series"></p>
                <p class="text-sm text-slate-500 dark:text-slate-300" id="paint-description"></p>
                <dl class="grid grid-cols-2 gap-4 text-sm text-slate-600 dark:text-slate-200">
                    <div>
                        <dt class="font-semibold text-slate-400">@Localizer["Card_Label_Type"]</dt>
                        <dd class="mt-1 text-slate-900 dark:text-slate-100" id="paint-type">—</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-slate-400">@Localizer["Card_Label_Finish"]</dt>
                        <dd class="mt-1 text-slate-900 dark:text-slate-100" id="paint-finish">—</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-slate-400">@Localizer["Card_Label_Medium"]</dt>
                        <dd class="mt-1 text-slate-900 dark:text-slate-100" id="paint-medium">—</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-slate-400">@Localizer["Card_Label_Sku"]</dt>
                        <dd class="mt-1 text-slate-900 dark:text-slate-100" id="paint-sku">—</dd>
                    </div>
                </dl>
                <dl class="grid grid-cols-1 gap-4 text-sm text-slate-600 dark:text-slate-200">
                    <div>
                        <dt class="font-semibold text-slate-400">@Localizer["Card_Label_Discontinued"]</dt>
                        <dd class="mt-1 text-slate-900 dark:text-slate-100" id="paint-discontinued">—</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-slate-400">@Localizer["Card_Label_BrandWebsite"]</dt>
                        <dd class="mt-1 text-slate-900 dark:text-slate-100" id="paint-brand-website">—</dd>
                    </div>
                    <div>
                        <dt class="font-semibold text-slate-400">@Localizer["Card_Label_Identifiers"]</dt>
                        <dd class="mt-1 space-y-1 text-slate-900 dark:text-slate-100" id="paint-identifiers">—</dd>
                    </div>
                </dl>
                <div class="flex flex-wrap gap-2" id="paint-tags"></div>
            </div>
            <div class="flex flex-col items-center justify-center gap-4">
                <div class="h-24 w-24 rounded-full border border-slate-200 shadow-inner" id="paint-swatch"></div>
                <div class="text-xs text-slate-500 dark:text-slate-300" id="paint-hex">#000000</div>
            </div>
        </div>
        <div id="paint-debug" class="mt-6 rounded-xl bg-slate-50 p-4 text-xs text-slate-600 dark:bg-slate-800 dark:text-slate-200">
            <p class="mb-2 font-semibold uppercase tracking-wide text-slate-500">@Localizer["Details_Debug"]</p>
            <pre class="whitespace-pre-wrap" id="paint-json"></pre>
        </div>
    </div>

    <div id="paint-error" class="hidden rounded-xl border border-red-200 bg-red-50 p-4 text-red-800 dark:border-red-900 dark:bg-red-950 dark:text-red-200">
        <p class="font-semibold">@Localizer["Details_Error_Title"]</p>
        <p class="text-sm">@Localizer["Details_Error_Description"]</p>
    </div>
</section>

@section Scripts {
    <script src="~/js/paint-swatch.js"></script>
    <script>
        (function() {
            const bootstrap = @Html.Raw(bootstrapJson);
            const rawJson = @Html.Raw(detailsJson);
            const enumLabels = bootstrap.enumLabels || {};
            const localized = {
                discontinuedYes: @Html.Raw(JsonSerializer.Serialize(Localizer["Card_Value_Discontinued_Yes"].Value, jsonOptions)),
                discontinuedNo: @Html.Raw(JsonSerializer.Serialize(Localizer["Card_Value_Discontinued_No"].Value, jsonOptions)),
                discontinuedUnknown: @Html.Raw(JsonSerializer.Serialize(Localizer["Card_Value_Discontinued_Unknown"].Value, jsonOptions)),
                brandWebsiteUnavailable: @Html.Raw(JsonSerializer.Serialize(Localizer["Card_Value_BrandWebsite_Unavailable"].Value, jsonOptions)),
                identifiersNone: @Html.Raw(JsonSerializer.Serialize(Localizer["Card_Value_Identifiers_None"].Value, jsonOptions))
            };

            const state = {
                paint: null,
                brandSlug: bootstrap.brandSlug,
                seriesSlug: bootstrap.seriesSlug,
                paintSlug: bootstrap.paintSlug,
            };

            const swatchUtils = window.paintSwatchUtils || {};
            const normalizeHex = swatchUtils.normalizeHex || (value => {
                if (!value) return null;
                const hex = String(value).trim();
                if (!hex) return null;
                return hex.startsWith('#') ? hex : `#${hex}`;
            });
            const buildPaintSwatch = swatchUtils.buildPaintSwatch || ((paint, fallbackHex, options = {}) => {
                const hex = normalizeHex(options.defaultHex) || normalizeHex(fallbackHex) || '#0f172a';
                return { background: hex, label: hex };
            });
            const resolveEnumLabel = (dictionary, rawValue, fallback) => {
                if (!dictionary) return fallback;

                let value = rawValue;
                if (value && typeof value === 'object') {
                    value = value.id ?? value.value ?? value.type ?? value.finish ?? value.medium;
                }

                if (value === null || value === undefined) return fallback;

                const key = String(value);
                return dictionary[key] || fallback;
            };

            function normalizeBoolean(value) {
                if (value === null || value === undefined) return null;
                if (typeof value === 'boolean') return value;

                if (typeof value === 'number') {
                    if (value === 1) return true;
                    if (value === 0) return false;
                }

                const normalized = String(value).trim().toLowerCase();
                if (['true', 'yes', 'y', '1', 'discontinued', 'retired', 'wycofana', 'wycofane', 'wycofany'].includes(normalized)) {
                    return true;
                }
                if (['false', 'no', 'n', '0', 'available', 'active'].includes(normalized)) {
                    return false;
                }

                return null;
            }

            function resolveDiscontinued(paint) {
                const candidate = paint?.isDiscontinued
                    ?? paint?.discontinued
                    ?? paint?.discontinuedFromSale
                    ?? paint?.retired
                    ?? paint?.isRetired
                    ?? paint?.status;

                return normalizeBoolean(candidate);
            }

            function formatDiscontinued(value) {
                if (value === true) return localized.discontinuedYes;
                if (value === false) return localized.discontinuedNo;
                return localized.discontinuedUnknown;
            }

            function resolveBrandWebsite(brand) {
                if (!brand) return null;

                const candidate = brand.websiteUrl
                    ?? brand.websiteURL
                    ?? brand.website
                    ?? brand.url
                    ?? brand.site
                    ?? brand.homepage
                    ?? brand.link
                    ?? brand.links?.website
                    ?? brand.links?.site
                    ?? brand.links?.homepage;

                const sanitized = sanitizeUrl(candidate);
                if (!sanitized) return null;

                let label = brand.name || '';
                try {
                    const url = new URL(sanitized);
                    if (url.hostname) {
                        label = label ? `${label} (${url.hostname})` : url.hostname;
                    }
                } catch {
                    label = label || sanitized;
                }

                return { url: sanitized, label: label || sanitized };
            }

            function sanitizeUrl(value) {
                if (!value) return null;

                const raw = String(value).trim();
                if (!raw) return null;

                const prefixed = /^https?:\/\//i.test(raw) ? raw : `https://${raw}`;

                try {
                    const url = new URL(prefixed);
                    if (['http:', 'https:'].includes(url.protocol)) {
                        return url.toString();
                    }
                } catch {
                    return null;
                }

                return null;
            }

            function normalizeIdentifiers(raw) {
                if (!raw) return [];

                if (Array.isArray(raw)) {
                    return raw.map(normalizeIdentifier).filter(Boolean);
                }

                if (typeof raw === 'object') {
                    return Object.entries(raw)
                        .map(([key, value]) => normalizeIdentifier({ type: key, value }))
                        .filter(Boolean);
                }

                return [];
            }

            function normalizeIdentifier(value) {
                if (value === null || value === undefined) return null;

                if (typeof value === 'string' || typeof value === 'number') {
                    const normalized = String(value).trim();
                    return normalized ? { label: null, value: normalized } : null;
                }

                if (typeof value === 'object') {
                    const identifierValue = value.value
                        ?? value.id
                        ?? value.code
                        ?? value.codeValue
                        ?? value.identifier
                        ?? value.number
                        ?? value.slug
                        ?? value.text;

                    if (!identifierValue && identifierValue !== 0) return null;

                    const labelParts = [];

                    if (value.bottleMl !== null && value.bottleMl !== undefined) {
                        const volume = Number(value.bottleMl);
                        if (!Number.isNaN(volume)) {
                            labelParts.push(`${volume}ml`);
                        }
                    }

                    const identifierLabel = value.type
                        ?? value.name
                        ?? value.label
                        ?? value.system
                        ?? value.scope
                        ?? value.source
                        ?? value.kind
                        ?? value.key
                        ?? value.codeType;

                    if (identifierLabel) {
                        labelParts.push(String(identifierLabel));
                    }

                    return {
                        label: labelParts.length ? labelParts.join(' · ') : null,
                        value: String(identifierValue)
                    };
                }

                return null;
            }

            function parsePaint() {
                if (!rawJson) return null;
                if (typeof rawJson === 'string') {
                    try {
                        return JSON.parse(rawJson);
                    } catch (err) {
                        console.error('Failed to parse paint JSON', err);
                        return null;
                    }
                }

                return rawJson;
            }

            function hydrate() {
                state.paint = parsePaint();
                if (!state.paint) {
                    toggleError(true);
                    return;
                }

                render();
            }

            function render() {
                const paint = state.paint;
                const elements = {
                    brand: document.getElementById('paint-brand'),
                    name: document.getElementById('paint-name'),
                    series: document.getElementById('paint-series'),
                    description: document.getElementById('paint-description'),
                    type: document.getElementById('paint-type'),
                    finish: document.getElementById('paint-finish'),
                    medium: document.getElementById('paint-medium'),
                    sku: document.getElementById('paint-sku'),
                    discontinued: document.getElementById('paint-discontinued'),
                    brandWebsite: document.getElementById('paint-brand-website'),
                    identifiers: document.getElementById('paint-identifiers'),
                    tags: document.getElementById('paint-tags'),
                    swatch: document.getElementById('paint-swatch'),
                    hex: document.getElementById('paint-hex'),
                    json: document.getElementById('paint-json'),
                    error: document.getElementById('paint-error'),
                    container: document.getElementById('paint-details')
                };

                const brandName = paint?.brand?.name || paint?.brandName || '';
                const brandSlug = paint?.brand?.slug || paint?.brandSlug || state.brandSlug;
                const seriesName = paint?.series?.name || paint?.seriesName || '';
                const seriesSlug = paint?.series?.slug || paint?.seriesSlug || state.seriesSlug;
                const paintName = paint?.name || paint?.paintName || state.paintSlug || 'Untitled paint';
                const description = paint?.description || '';
                const finishRaw = paint?.finishId ?? paint?.finish?.id ?? paint?.finish;
                const typeRaw = paint?.typeId ?? paint?.type?.id ?? paint?.type;
                const mediumRaw = paint?.mediumId ?? paint?.medium?.id ?? paint?.medium;
                const finishName = resolveEnumLabel(enumLabels.finish, finishRaw, paint?.finishName || paint?.finish?.name || paint?.finish || '—');
                const typeName = resolveEnumLabel(enumLabels.type, typeRaw, paint?.typeName || paint?.type?.name || paint?.type || '—');
                const mediumName = resolveEnumLabel(enumLabels.medium, mediumRaw, paint?.mediumName || paint?.medium?.name || paint?.medium || '—');
                const sku = paint?.sku || paint?.code || '—';
                const colorHex = paint?.hex || paint?.colorHex || paint?.hexCode || paint?.swatchHex || '#0f172a';
                const swatch = buildPaintSwatch(paint, colorHex, { defaultHex: '#0f172a' });
                const tags = Array.isArray(paint?.tags) ? paint.tags : [];
                const discontinued = resolveDiscontinued(paint);
                const brandWebsite = resolveBrandWebsite(paint?.brand);
                const identifiers = normalizeIdentifiers(paint?.identifiers || paint?.ids || paint?.codes || paint?.references);

                if (elements.brand) {
                    const brandLabel = brandSlug ? `${brandName || 'Brand'} (${brandSlug})` : (brandName || 'Brand');
                    elements.brand.textContent = brandLabel;
                }

                if (elements.name) {
                    elements.name.textContent = paintName;
                }

                if (elements.series) {
                    const seriesLabel = seriesSlug ? `${seriesName || 'Series'} (${seriesSlug})` : (seriesName || 'Series');
                    elements.series.textContent = seriesLabel;
                }

                if (elements.description) {
                    elements.description.textContent = description;
                    elements.description.classList.toggle('hidden', !description);
                }

                if (elements.type) elements.type.textContent = typeName || '—';
                if (elements.finish) elements.finish.textContent = finishName || '—';
                if (elements.medium) elements.medium.textContent = mediumName || '—';
                if (elements.sku) elements.sku.textContent = sku || '—';

                if (elements.discontinued) elements.discontinued.textContent = formatDiscontinued(discontinued);

                if (elements.brandWebsite) {
                    if (brandWebsite?.url) {
                        const label = brandWebsite.label || brandWebsite.url;
                        elements.brandWebsite.innerHTML = `<a href="${escapeHtml(brandWebsite.url)}" target="_blank" rel="noreferrer noopener" class="text-emerald-600 hover:underline dark:text-emerald-400">${escapeHtml(label)}</a>`;
                    } else {
                        elements.brandWebsite.textContent = localized.brandWebsiteUnavailable;
                    }
                }

                if (elements.identifiers) {
                    if (!identifiers.length) {
                        elements.identifiers.textContent = localized.identifiersNone;
                    } else {
                        elements.identifiers.innerHTML = identifiers
                            .map(item => {
                                const label = item.label ? `<span class="rounded-full bg-slate-100 px-2 py-0.5 text-xs text-slate-600 dark:bg-slate-800 dark:text-slate-200">${escapeHtml(item.label)}</span>` : '';
                                const value = `<span class="font-mono text-xs text-slate-900 dark:text-slate-100">${escapeHtml(item.value)}</span>`;
                                return `<div class="flex flex-wrap items-center gap-2">${label}${value}</div>`;
                            })
                            .join('');
                    }
                }

                if (elements.tags) {
                    if (tags.length === 0) {
                        elements.tags.innerHTML = '';
                    } else {
                        elements.tags.innerHTML = tags
                            .map(tag => typeof tag === 'string' ? tag : (tag?.name || tag?.label))
                            .filter(Boolean)
                            .map(tag => `<span class="rounded-full bg-slate-100 px-2 py-0.5 text-xs text-slate-600 dark:bg-slate-800 dark:text-slate-200">${escapeHtml(tag)}</span>`)
                            .join('');
                    }
                }

                if (elements.swatch) {
                    elements.swatch.style.background = swatch.background || colorHex;
                }

                if (elements.hex) {
                    elements.hex.textContent = swatch.label || colorHex;
                }

                if (elements.json) {
                    try {
                        elements.json.textContent = JSON.stringify(paint, null, 2);
                    } catch {
                        elements.json.textContent = paint?.toString?.() ?? '';
                    }
                }

                toggleError(false);
                if (elements.container) {
                    elements.container.classList.remove('hidden');
                }
            }

            function escapeHtml(value) {
                if (value === null || value === undefined) {
                    return '';
                }

                return String(value)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
            }

            function toggleError(isError) {
                const errorBox = document.getElementById('paint-error');
                const container = document.getElementById('paint-details');
                if (errorBox) {
                    errorBox.classList.toggle('hidden', !isError);
                }
                if (container) {
                    container.classList.toggle('hidden', isError);
                }
            }

            hydrate();
        })();
    </script>
}
