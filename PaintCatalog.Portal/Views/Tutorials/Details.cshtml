@model PaintCatalog.Portal.Models.Tutorials.TutorialDetailsViewModel
@using System.Linq
@using System.Net
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Html
@using PaintCatalog.Portal.Helpers
@using PaintCatalog.Portal.Models.Api
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["Page_Title", Model.Title].Value;
    ViewData["MetaDescription"] = Localizer["Page_Description"].Value;
    var paintDetailsTemplate = CultureHelpers.GetRouteCultureSegment() is string cultureSegment
        ? Url.RouteUrl("PaintDetailsLocalized", new { culture = cultureSegment, brandSlug = "__brand__", seriesSlug = "__series__", paintSlug = "__paint__" }) ?? "/pl/paints/__brand__/__series__/__paint__"
        : Url.RouteUrl("PaintDetails", new { brandSlug = "__brand__", seriesSlug = "__series__", paintSlug = "__paint__" }) ?? "/paints/__brand__/__series__/__paint__";
    var sections = Model.Content?.Sections ?? new List<TutorialSectionDto>();
}

@section Scripts {
    <script src="~/js/paint-swatch.js"></script>
    <script>
        (function () {
            const badges = Array.from(document.querySelectorAll('[data-paint-badge]'));
            if (!badges.length) return;

            const detailsTemplate = '@paintDetailsTemplate';
            const paintIds = [...new Set(badges.map(b => b.dataset.paintId).filter(Boolean))];
            if (!paintIds.length) return;

            const idsQuery = paintIds.map(id => `ids=${encodeURIComponent(id)}`).join('&');
            if (!idsQuery) return;

            function buildDetailsUrl(brandSlug, seriesSlug, paintSlug) {
                if (!brandSlug || !seriesSlug || !paintSlug || !detailsTemplate) return null;
                return detailsTemplate
                    .replace('__brand__', encodeURIComponent(brandSlug))
                    .replace('__series__', encodeURIComponent(seriesSlug))
                    .replace('__paint__', encodeURIComponent(paintSlug));
            }

            function renderBadge(badge, paint) {
                const id = badge.dataset.paintId || '';
                const paintId = paint?.id ?? paint?.paintId ?? paint?.Id ?? id;
                const name = paint?.name || paint?.title || `Paint #${paintId}`;
                const brandName = (paint?.brand?.name) || paint?.brandName || '';
                const brandSlug = (paint?.brand?.slug) || paint?.brandSlug || paint?.brand?.urlSlug || '';
                const seriesName = (paint?.series?.name) || paint?.seriesName || '';
                const seriesSlug = (paint?.series?.slug) || paint?.seriesSlug || paint?.series?.urlSlug || '';
                const paintSlug = paint?.slug || paint?.paintSlug || '';
                const sku = paint?.sku || paint?.code || '';
                const meta = [brandName, seriesName, sku].filter(Boolean).join(' • ');
                const swatch = (window.paintSwatchUtils?.buildPaintSwatch?.(paint, '#475569')) || { background: '#475569', label: '#475569' };
                const detailsUrl = buildDetailsUrl(brandSlug, seriesSlug, paintSlug);

                const content = `
                    <span class="inline-flex items-center gap-2">
                        <span class="h-4 w-4 rounded-full border border-white/50 shadow-inner dark:border-slate-800" style="background:${swatch.background}" title="${meta ? meta : swatch.label}"></span>
                        <span class="paint-badge__name">${name}</span>
                        <span class="paint-badge__meta text-[10px] font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-300">#${paintId}${meta ? ' • ' + meta : ''}</span>
                    </span>`;

                if (detailsUrl) {
                    badge.innerHTML = `<a class="flex items-center gap-2 no-underline hover:text-emerald-700 dark:hover:text-emerald-200" href="${detailsUrl}">${content}</a>`;
                } else {
                    badge.innerHTML = content;
                }
            }

            (async function hydrateBadges() {
                try {
                    const response = await fetch(`/paints/data?${idsQuery}`, { credentials: 'include' });
                    if (!response.ok) return;

                    const payload = await response.json();
                    const items = Array.isArray(payload?.items) ? payload.items : (Array.isArray(payload) ? payload : []);
                    const paintsById = new Map();

                    items.forEach(paint => {
                        const paintId = paint?.id ?? paint?.paintId ?? paint?.Id;
                        if (paintId !== undefined && paintId !== null) {
                            paintsById.set(String(paintId), paint);
                        }
                    });

                    paintIds.forEach(id => {
                        const paint = paintsById.get(String(id));
                        if (!paint) return;
                        badges
                            .filter(badge => badge.dataset.paintId === String(id))
                            .forEach(badge => renderBadge(badge, paint));
                    });
                } catch (error) {
                    console.error('Failed to load paints', paintIds, error);
                }
            })();
        })();
    </script>
}

<article class="space-y-10">
    <header class="space-y-3">
        <h1 class="text-3xl font-semibold text-slate-900 dark:text-white">@Model.Title</h1>
        <p class="text-sm text-slate-500 dark:text-slate-300">
            @Localizer["Meta_Id"]: @Model.Id • @Localizer["Meta_Created"]: @FormatDate(Model.CreatedAtUtc) • @Localizer["Meta_Updated"]: @FormatDate(Model.UpdatedAtUtc)
        </p>
        @if (Model.Published)
        {
            <p class="text-sm font-semibold text-emerald-600 dark:text-emerald-300">@Localizer["Status_Published"]</p>
        }
        else
        {
            <p class="text-sm font-semibold text-amber-600 dark:text-amber-300">@Localizer["Status_Draft"]</p>
        }
    </header>

    @if (Model.TitleImageAttachmentId.HasValue)
    {
        <figure class="space-y-2">
            <img src="/attachments/@Model.TitleImageAttachmentId" alt="@Model.Title" class="w-full rounded-xl object-cover" />
        </figure>
    }

    @if (sections.Count == 0)
    {
        <p class="text-sm text-slate-600 dark:text-slate-300">@Localizer["Content_Empty"]</p>
    }
    else
    {
        foreach (var section in sections)
        {
            var items = section.Items ?? new List<TutorialSectionItemDto>();
            var sectionTitle = string.IsNullOrWhiteSpace(section.Title)
                ? Localizer["Content_Section_Fallback", string.Empty].Value?.Trim()
                : section.Title;
            <section class="space-y-4">
                <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">@(string.IsNullOrWhiteSpace(sectionTitle) ? Localizer["Content_Title"] : sectionTitle)</h2>

                @if (items.Count == 0)
                {
                    <p class="text-sm text-slate-600 dark:text-slate-300">@Localizer["Content_Section_Empty"]</p>
                }
                else
                {
                    <div class="space-y-4">
                        @foreach (var item in items)
                        {
                            var type = NormalizeType(item.Type);
                            if (type == "header")
                            {
                                <h3 class="text-xl font-semibold text-slate-900 dark:text-white">@item.Text</h3>
                            }
                            else if (type == "image")
                            {
                                <figure class="space-y-2">
                                    @if (item.AttachmentId.HasValue)
                                    {
                                        <img src="/attachments/@item.AttachmentId" alt="@item.Alt" class="w-full rounded-lg object-cover" />
                                    }
                                    @if (!string.IsNullOrWhiteSpace(item.Caption))
                                    {
                                        <figcaption class="text-sm text-slate-500 dark:text-slate-400">@item.Caption</figcaption>
                                    }
                                </figure>
                            }
                            else if (type == "step")
                            {
                                var steps = item.Steps ?? new List<TutorialStepDto>();
                                if (steps.Count == 0)
                                {
                                    <div class="space-y-2">
                                        @RenderRichText(item.Text)
                                        @RenderPaintList(item.PaintIds)
                                    </div>
                                }
                                else
                                {
                                    <ol class="space-y-3 list-decimal pl-5 text-slate-800 dark:text-slate-100">
                                        @for (var i = 0; i < steps.Count; i++)
                                        {
                                            var step = steps[i];
                                            <li class="space-y-1">
                                                @if (!string.IsNullOrWhiteSpace(step.Title))
                                                {
                                                    <p class="font-semibold">@step.Title</p>
                                                }
                                                @RenderRichText(step.Text)
                                                @RenderPaintList(step.PaintIds)
                                            </li>
                                        }
                                    </ol>
                                }
                            }
                            else
                            {
                                <div class="space-y-2">
                                    @RenderRichText(item.Text)
                                    @RenderPaintList(item.PaintIds)
                                </div>
                            }
                        }
                    </div>
                }
            </section>
        }
    }

    <div class="flex gap-4">
        <a href="@Url.Action("Edit", "Tutorials", new { id = Model.Id })" class="text-sm font-semibold text-amber-700 hover:text-amber-800 dark:text-amber-300 dark:hover:text-amber-200">
            @Localizer["Action_Edit"]
        </a>
        <a href="@Url.Action("Index", "Tutorials")" class="text-sm font-semibold text-slate-700 hover:text-slate-900 dark:text-slate-200 dark:hover:text-white">
            @Localizer["Action_Back"]
        </a>
    </div>
</article>

@functions {
    private static string FormatDate(DateTime? date)
    {
        return date.HasValue ? date.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm") : "–";
    }

    private static string NormalizeType(string? type)
    {
        return string.IsNullOrWhiteSpace(type) ? "text" : type.ToLowerInvariant();
    }

    private static IHtmlContent RenderRichText(string? text)
    {
        if (string.IsNullOrWhiteSpace(text))
        {
            return new HtmlString("<p class=\"text-xs text-slate-500 dark:text-slate-400\">–</p>");
        }

        var encoded = WebUtility.HtmlEncode(text);
        var withPaintBadges = Regex.Replace(encoded, "\\{\\{paint:(\\d+)\\}\\}", match => BuildPaintBadge(match.Groups[1].Value));
        var withBreaks = withPaintBadges.Replace("\n", "<br />");
        return new HtmlString($"<p class=\"leading-relaxed text-slate-800 dark:text-slate-100\">{withBreaks}</p>");
    }

    private static IHtmlContent RenderPaintList(IEnumerable<int>? explicitIds)
    {
        var paints = CollectPaintIds(explicitIds).ToList();
        if (paints.Count == 0)
        {
            return HtmlString.Empty;
        }

        var badges = string.Join("", paints.Select(id => BuildPaintBadge(id.ToString())));
        return new HtmlString($"<div class=\"flex flex-wrap gap-2 text-xs\">{badges}</div>");
    }

    private static IEnumerable<int> CollectPaintIds(IEnumerable<int>? explicitIds)
    {
        return new SortedSet<int>(explicitIds ?? Enumerable.Empty<int>());
    }

    private static string BuildPaintBadge(string id)
    {
        return $"<span class=\"paint-badge inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/80 px-3 py-1 text-xs font-semibold text-slate-800 shadow-sm dark:border-slate-700 dark:bg-slate-900/50 dark:text-slate-200\" data-paint-badge data-paint-id=\"{id}\"><span class=\"h-4 w-4 rounded-full border border-white/50 bg-slate-600 shadow-inner dark:border-slate-800\"></span><span class=\"paint-badge__name\">Paint #{id}</span><span class=\"paint-badge__meta text-[10px] font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-300\">#{id}</span></span>";
    }
}
