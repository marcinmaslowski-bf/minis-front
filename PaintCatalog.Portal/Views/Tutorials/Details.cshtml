@model PaintCatalog.Portal.Models.Tutorials.TutorialDetailsViewModel
@using System.Linq
@using System.Net
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Html
@using PaintCatalog.Portal.Models.Api
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["Page_Title", Model.Title].Value;
    ViewData["MetaDescription"] = Localizer["Page_Description"].Value;
    var sections = Model.Content?.Sections ?? new List<TutorialSectionDto>();
}

<section class="space-y-6">
    <div class="flex flex-wrap items-start justify-between gap-4">
        <div class="space-y-1">
            <p class="text-xs font-semibold uppercase tracking-wide text-emerald-500">@Localizer["Header_Badge"]</p>
            <h1 class="text-2xl font-semibold text-slate-900 dark:text-white">@Model.Title</h1>
            <div class="flex flex-wrap items-center gap-3 text-xs text-slate-500 dark:text-slate-300">
                <span>@Localizer["Meta_Id"]: @Model.Id</span>
                <span>•</span>
                <span>@Localizer["Meta_TitleImage"]: @(Model.TitleImageAttachmentId?.ToString() ?? "–")</span>
                <span>•</span>
                <span>@Localizer["Meta_Created"]: @FormatDate(Model.CreatedAtUtc)</span>
                <span>•</span>
                <span>@Localizer["Meta_Updated"]: @FormatDate(Model.UpdatedAtUtc)</span>
            </div>
        </div>
        <div class="flex flex-wrap gap-2">
            <div class="flex items-center gap-2 rounded-full border px-3 py-1 text-xs font-semibold @(Model.Published ? "border-emerald-200 bg-emerald-50 text-emerald-700 dark:border-emerald-600/60 dark:bg-emerald-900/40 dark:text-emerald-100" : "border-amber-200 bg-amber-50 text-amber-700 dark:border-amber-600/60 dark:bg-amber-900/40 dark:text-amber-100")">
                <span class="h-2 w-2 rounded-full @(Model.Published ? "bg-emerald-500" : "bg-amber-400")"></span>
                <span>@(Model.Published ? Localizer["Status_Published"] : Localizer["Status_Draft"])</span>
            </div>
            <a href="@Url.Action("Edit", "Tutorials", new { id = Model.Id })"
               class="inline-flex items-center gap-2 rounded-xl border border-amber-300 px-4 py-2 text-sm font-semibold text-amber-700 transition hover:border-amber-500 hover:text-amber-600 dark:border-amber-700 dark:text-amber-200 dark:hover:border-amber-500 dark:hover:text-amber-100">
                @Localizer["Action_Edit"]
            </a>
            <a href="@Url.Action("Index", "Tutorials")"
               class="inline-flex items-center gap-2 rounded-xl border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-500 hover:text-slate-900 dark:border-slate-700 dark:text-slate-200 dark:hover:border-slate-500">
                @Localizer["Action_Back"]
            </a>
        </div>
    </div>

    <div class="grid gap-4 lg:grid-cols-3">
        <div class="space-y-4 lg:col-span-2">
            <div class="overflow-hidden rounded-2xl border border-slate-200 bg-white/80 shadow-sm dark:border-slate-800 dark:bg-slate-900/60">
                @if (Model.TitleImageAttachmentId.HasValue)
                {
                    <img src="/attachments/@Model.TitleImageAttachmentId"
                         alt="@Model.Title"
                         class="h-64 w-full object-cover" />
                }
                else
                {
                    <div class="flex h-64 items-center justify-center bg-slate-50 text-sm text-slate-500 dark:bg-slate-800 dark:text-slate-300">
                        @Localizer["Meta_TitleImage"]: @Localizer["Content_Missing"]
                    </div>
                }
            </div>

            <div class="space-y-4 rounded-2xl border border-slate-200 bg-white/80 p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900/60">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs font-semibold uppercase tracking-wide text-emerald-500">@Localizer["Content_Badge"]</p>
                        <p class="text-lg font-semibold text-slate-900 dark:text-white">@Localizer["Content_Title"]</p>
                    </div>
                    <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-700 dark:bg-slate-800 dark:text-slate-200">
                        @Localizer["Content_Sections", sections.Count]
                    </span>
                </div>

                @if (sections.Count == 0)
                {
                    <div class="rounded-xl border border-dashed border-slate-200 bg-slate-50/80 p-4 text-sm text-slate-600 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-300">
                        @Localizer["Content_Empty"]
                    </div>
                }
                else
                {
                    var sectionIndex = 0;
                    foreach (var section in sections)
                    {
                        var items = section.Items ?? new List<TutorialSectionItemDto>();
                        <div class="space-y-3 rounded-xl border border-slate-200 bg-white/90 p-4 shadow-sm dark:border-slate-800 dark:bg-slate-950/40">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <p class="text-xs font-semibold uppercase tracking-wide text-emerald-500">@Localizer["Content_Section_Label", ++sectionIndex]</p>
                                    <h2 class="text-lg font-semibold text-slate-900 dark:text-white">@(string.IsNullOrWhiteSpace(section.Title) ? Localizer["Content_Section_Fallback", sectionIndex] : section.Title)</h2>
                                </div>
                                <span class="rounded-full bg-slate-100 px-2 py-1 text-[11px] font-semibold text-slate-600 dark:bg-slate-900 dark:text-slate-300">@Localizer["Content_Items", items.Count]</span>
                            </div>

                            @if (items.Count == 0)
                            {
                                <p class="rounded-lg border border-dashed border-slate-200 bg-slate-50/70 p-3 text-xs text-slate-500 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-300">
                                    @Localizer["Content_Section_Empty"]
                                </p>
                            }
                            else
                            {
                                <div class="space-y-4">
                                    @foreach (var item in items)
                                    {
                                        var type = NormalizeType(item.Type);
                                        if (type == "header")
                                        {
                                            <div class="space-y-1 rounded-lg bg-emerald-50/60 p-3 dark:bg-emerald-900/20">
                                                <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-200">@Localizer["Content_Item_Header"]</p>
                                                <h3 class="text-base font-semibold text-slate-900 dark:text-white">@item.Text</h3>
                                            </div>
                                        }
                                        else if (type == "image")
                                        {
                                            <figure class="space-y-2 rounded-lg border border-slate-200 bg-slate-50/70 p-3 dark:border-slate-700 dark:bg-slate-900/40">
                                                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">@Localizer["Content_Item_Image"]</p>
                                                @if (item.AttachmentId.HasValue)
                                                {
                                                    <img src="/attachments/@item.AttachmentId" alt="@item.Alt" class="w-full rounded-lg object-cover" />
                                                }
                                                else
                                                {
                                                    <div class="flex h-40 items-center justify-center rounded-lg border border-dashed border-slate-200 bg-white/60 text-xs text-slate-500 dark:border-slate-700 dark:bg-slate-950/30 dark:text-slate-300">
                                                        @Localizer["Content_Missing"]
                                                    </div>
                                                }
                                                @if (!string.IsNullOrWhiteSpace(item.Caption))
                                                {
                                                    <figcaption class="text-xs text-slate-500 dark:text-slate-400">@item.Caption</figcaption>
                                                }
                                            </figure>
                                        }
                                        else if (type == "step")
                                        {
                                            var steps = item.Steps ?? new List<TutorialStepDto>();
                                            <div class="space-y-3 rounded-lg border border-emerald-100 bg-emerald-50/60 p-3 dark:border-emerald-800 dark:bg-emerald-950/20">
                                                <p class="text-[11px] font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-200">@Localizer["Content_Item_Steps"]</p>
                                                @if (steps.Count == 0)
                                                {
                                                    <div class="space-y-2">
                                                        @RenderRichText(item.Text)
                                                        @RenderPaintList(item.Text, item.PaintIds)
                                                    </div>
                                                }
                                                else
                                                {
                                                    <ol class="space-y-3">
                                                        @for (var i = 0; i < steps.Count; i++)
                                                        {
                                                            var step = steps[i];
                                                            <li class="space-y-1 rounded-lg bg-white/80 p-3 shadow-sm dark:bg-slate-950/50">
                                                                <div class="flex items-start justify-between gap-3">
                                                                    <div class="space-y-1">
                                                                        <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">@Localizer["Content_Item_StepLabel", i + 1]</p>
                                                                        @if (!string.IsNullOrWhiteSpace(step.Title))
                                                                        {
                                                                            <p class="font-semibold text-slate-900 dark:text-white">@step.Title</p>
                                                                        }
                                                                    </div>
                                                                    <span class="rounded-full bg-emerald-100 px-2 py-1 text-[10px] font-semibold uppercase tracking-wide text-emerald-700 dark:bg-emerald-900/50 dark:text-emerald-100">#@(i + 1)</span>
                                                                </div>
                                                                @RenderRichText(step.Text)
                                                                @RenderPaintList(step.Text, step.PaintIds)
                                                            </li>
                                                        }
                                                    </ol>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <div class="space-y-2 rounded-lg border border-slate-200 bg-slate-50/70 p-3 dark:border-slate-700 dark:bg-slate-900/40">
                                                <p class="text-[11px] font-semibold uppercase tracking-wide text-slate-500 dark:text-slate-400">@Localizer["Content_Item_Text"]</p>
                                                @RenderRichText(item.Text)
                                                @RenderPaintList(item.Text, item.PaintIds)
                                            </div>
                                        }
                                    }
                                </div>
                            }
                        </div>
                    }
                }
            </div>
        </div>

        <aside class="space-y-3 rounded-2xl border border-slate-200 bg-white/80 p-4 text-sm text-slate-700 shadow-sm dark:border-slate-800 dark:bg-slate-900/60 dark:text-slate-200">
            <p class="text-xs font-semibold uppercase tracking-wide text-emerald-500">@Localizer["Meta_Title"]</p>
            <dl class="space-y-2">
                <div class="flex items-center justify-between gap-2">
                    <dt class="text-xs text-slate-500 dark:text-slate-400">@Localizer["Meta_Id"]</dt>
                    <dd class="font-semibold text-slate-900 dark:text-white">@Model.Id</dd>
                </div>
                <div class="flex items-center justify-between gap-2">
                    <dt class="text-xs text-slate-500 dark:text-slate-400">@Localizer["Meta_Created"]</dt>
                    <dd>@FormatDate(Model.CreatedAtUtc)</dd>
                </div>
                <div class="flex items-center justify-between gap-2">
                    <dt class="text-xs text-slate-500 dark:text-slate-400">@Localizer["Meta_Updated"]</dt>
                    <dd>@FormatDate(Model.UpdatedAtUtc)</dd>
                </div>
                <div class="flex items-center justify-between gap-2">
                    <dt class="text-xs text-slate-500 dark:text-slate-400">@Localizer["Meta_TitleImage"]</dt>
                    <dd>@(Model.TitleImageAttachmentId?.ToString() ?? "–")</dd>
                </div>
                <div class="flex items-center justify-between gap-2">
                    <dt class="text-xs text-slate-500 dark:text-slate-400">@Localizer["Meta_Status"]</dt>
                    <dd class="font-semibold @(Model.Published ? "text-emerald-600" : "text-amber-600")">@(Model.Published ? Localizer["Status_Published"] : Localizer["Status_Draft"])</dd>
                </div>
            </dl>
            <details class="rounded-xl border border-slate-200 bg-slate-50/70 p-3 text-xs text-slate-600 dark:border-slate-700 dark:bg-slate-900/40 dark:text-slate-300">
                <summary class="cursor-pointer font-semibold text-slate-800 dark:text-slate-100">@Localizer["Content_RawJson"]</summary>
                <pre class="mt-2 max-h-72 overflow-auto rounded-lg bg-slate-900 p-2 text-[11px] text-emerald-100 dark:bg-slate-950">@Model.ContentJson</pre>
            </details>
        </aside>
    </div>
</section>

@functions {
    private static string FormatDate(DateTime? date)
    {
        return date.HasValue ? date.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm") : "–";
    }

    private static string NormalizeType(string? type)
    {
        return string.IsNullOrWhiteSpace(type) ? "text" : type.ToLowerInvariant();
    }

    private static IHtmlContent RenderRichText(string? text)
    {
        if (string.IsNullOrWhiteSpace(text))
        {
            return new HtmlString("<p class=\"text-xs text-slate-500 dark:text-slate-400\">–</p>");
        }

        var encoded = WebUtility.HtmlEncode(text);
        var withPaintBadges = Regex.Replace(encoded, "\\{\\{paint:(\\d+)\\}\\}", match => BuildPaintBadge(match.Groups[1].Value));
        var withBreaks = withPaintBadges.Replace("\n", "<br />");
        return new HtmlString($"<p class=\"leading-relaxed text-slate-800 dark:text-slate-100\">{withBreaks}</p>");
    }

    private static IHtmlContent RenderPaintList(string? text, IEnumerable<int>? explicitIds)
    {
        var paints = CollectPaintIds(text, explicitIds).ToList();
        if (paints.Count == 0)
        {
            return HtmlString.Empty;
        }

        var badges = string.Join("", paints.Select(id => BuildPaintBadge(id.ToString())));
        return new HtmlString($"<div class=\"flex flex-wrap gap-2 text-xs\">{badges}</div>");
    }

    private static IEnumerable<int> CollectPaintIds(string? text, IEnumerable<int>? explicitIds)
    {
        var ids = new SortedSet<int>(explicitIds ?? Enumerable.Empty<int>());

        if (!string.IsNullOrWhiteSpace(text))
        {
            foreach (Match match in Regex.Matches(text, "\\{\\{paint:(\\d+)\\}\\}"))
            {
                if (int.TryParse(match.Groups[1].Value, out var id))
                {
                    ids.Add(id);
                }
            }
        }

        return ids;
    }

    private static string BuildPaintBadge(string id)
    {
        return $"<span class=\"inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-50 px-2 py-1 text-xs font-semibold text-emerald-700 shadow-sm dark:border-emerald-900 dark:bg-emerald-950/50 dark:text-emerald-200\"><span class=\"h-2 w-2 rounded-full bg-emerald-500\"></span><span>Paint #{id}</span></span>";
    }
}
