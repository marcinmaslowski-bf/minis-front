@model PaintCatalog.Portal.Models.Tutorials.TutorialDetailsViewModel
@using System.Linq
@using System.Net
@using System.Text.RegularExpressions
@using System.Text.Json
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Html
@using PaintCatalog.Portal.Helpers
@using PaintCatalog.Portal.Models.Api
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["Page_Title", Model.Title].Value;
    ViewData["MetaDescription"] = Localizer["Page_Description"].Value;
    var jsonOptions = new JsonSerializerOptions
    {
        Encoder = JavaScriptEncoder.UnsafeRelaxedJsonEscaping
    };
    var bookmarkJson = JsonSerializer.Serialize(Model.Bookmark, jsonOptions);
    var paintDetailsTemplate = CultureHelpers.GetRouteCultureSegment() is string cultureSegment
        ? Url.RouteUrl("PaintDetailsLocalized", new { culture = cultureSegment, brandSlug = "__brand__", seriesSlug = "__series__", paintSlug = "__paint__" }) ?? "/pl/paints/__brand__/__series__/__paint__"
        : Url.RouteUrl("PaintDetails", new { brandSlug = "__brand__", seriesSlug = "__series__", paintSlug = "__paint__" }) ?? "/paints/__brand__/__series__/__paint__";
    var sections = Model.Content?.Sections ?? new List<TutorialSectionDto>();
}

@section Scripts {
    <script src="~/js/bookmarks.js"></script>
    <script src="~/js/paint-swatch.js"></script>
    <script>
        (function () {
            const badges = Array.from(document.querySelectorAll('[data-paint-badge]'));
            if (!badges.length) return;

            const detailsTemplate = '@paintDetailsTemplate';
            const paintIds = [...new Set(badges.map(b => b.dataset.paintId).filter(Boolean))];
            if (!paintIds.length) return;

            const idsQuery = paintIds.map(id => `ids=${encodeURIComponent(id)}`).join('&');
            if (!idsQuery) return;

            function buildDetailsUrl(brandSlug, seriesSlug, paintSlug) {
                if (!brandSlug || !seriesSlug || !paintSlug || !detailsTemplate) return null;
                return detailsTemplate
                    .replace('__brand__', encodeURIComponent(brandSlug))
                    .replace('__series__', encodeURIComponent(seriesSlug))
                    .replace('__paint__', encodeURIComponent(paintSlug));
            }

            function renderBadge(badge, paint) {
                const id = badge.dataset.paintId || '';
                const paintId = paint?.id ?? paint?.paintId ?? paint?.Id ?? id;
                const name = paint?.name || paint?.title || `Paint #${paintId}`;
                const brandName = (paint?.brand?.name) || paint?.brandName || '';
                const brandSlug = (paint?.brand?.slug) || paint?.brandSlug || paint?.brand?.urlSlug || '';
                const seriesName = (paint?.series?.name) || paint?.seriesName || '';
                const seriesSlug = (paint?.series?.slug) || paint?.seriesSlug || paint?.series?.urlSlug || '';
                const paintSlug = paint?.slug || paint?.paintSlug || '';
                const sku = paint?.sku || paint?.code || '';
                const meta = [brandName, seriesName, sku].filter(Boolean).join(' • ');
                const swatch = (window.paintSwatchUtils?.buildPaintSwatch?.(paint, '#475569')) || { background: '#475569', label: '#475569' };
                const detailsUrl = buildDetailsUrl(brandSlug, seriesSlug, paintSlug);

                const content = `
                    <span class="inline-flex items-center gap-2">
                        <span class="h-4 w-4 rounded-full border border-white/50 shadow-inner dark:border-slate-800" style="background:${swatch.background}" title="${meta ? meta : swatch.label}"></span>
                        <span class="paint-badge__name">${name}</span>
                        <span class="paint-badge__meta text-[10px] font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-300">#${paintId}${meta ? ' • ' + meta : ''}</span>
                    </span>`;

                if (detailsUrl) {
                    badge.innerHTML = `<a class="flex items-center gap-2 no-underline hover:text-emerald-700 dark:hover:text-emerald-200" href="${detailsUrl}">${content}</a>`;
                } else {
                    badge.innerHTML = content;
                }
            }

            (async function hydrateBadges() {
                try {
                    const response = await fetch(`/paints/data?${idsQuery}`, { credentials: 'include' });
                    if (!response.ok) return;

                    const payload = await response.json();
                    const items = Array.isArray(payload?.items) ? payload.items : (Array.isArray(payload) ? payload : []);
                    const paintsById = new Map();

                    items.forEach(paint => {
                        const paintId = paint?.id ?? paint?.paintId ?? paint?.Id;
                        if (paintId !== undefined && paintId !== null) {
                            paintsById.set(String(paintId), paint);
                        }
                    });

                    paintIds.forEach(id => {
                        const paint = paintsById.get(String(id));
                        if (!paint) return;
                        badges
                            .filter(badge => badge.dataset.paintId === String(id))
                            .forEach(badge => renderBadge(badge, paint));
                    });
                } catch (error) {
                    console.error('Failed to load paints', paintIds, error);
                }
            })();
        })();
    </script>
    <script>
        (function () {
            const bookmarkConfig = {
                triggerSelector: '#bookmark-trigger',
                modalSelector: '#bookmark-modal',
                categorySelector: '#bookmark-category',
                newCategorySelector: '#bookmark-new-category',
                addCategorySelector: '#bookmark-add-category',
                noteSelector: '#bookmark-note',
                saveSelector: '#bookmark-save',
                removeSelector: '#bookmark-remove',
                cancelSelector: '#bookmark-cancel',
                statusSelector: '#bookmark-status',
                errorSelector: '#bookmark-error',
                itemId: @Model.Id,
                itemType: 2,
                initialBookmark: @Html.Raw(string.IsNullOrWhiteSpace(bookmarkJson) ? "null" : bookmarkJson),
                endpoints: {
                    categories: '@(Url.Action("Categories", "Bookmarks") ?? "/bookmarks/categories")',
                    createCategory: '@(Url.Action("CreateCategory", "Bookmarks") ?? "/bookmarks/categories")',
                    upsert: '@(Url.Action("Upsert", "Bookmarks") ?? "/bookmarks")',
                    delete: '@(Url.Action("Delete", "Bookmarks", new { itemType = 2, itemId = Model.Id }) ?? $"/bookmarks/2/{Model.Id}")'
                },
                auth: {
                    isAuthenticated: @(User?.Identity?.IsAuthenticated ?? false ? "true" : "false"),
                    loginUrl: '@(Url.Action("Login", "Account", new { returnUrl = Context.Request.Path + Context.Request.QueryString }) ?? "/login")'
                },
                labels: {
                    buttonSave: @Html.Raw(JsonSerializer.Serialize(Localizer["Bookmark_Button_Save"].Value, jsonOptions)),
                    buttonSaved: @Html.Raw(JsonSerializer.Serialize(Localizer["Bookmark_Button_Saved"].Value, jsonOptions)),
                    statusSaved: @Html.Raw(JsonSerializer.Serialize(Localizer["Bookmark_Status_Saved"].Value, jsonOptions)),
                    statusRemoved: @Html.Raw(JsonSerializer.Serialize(Localizer["Bookmark_Status_Removed"].Value, jsonOptions)),
                    errorLoad: @Html.Raw(JsonSerializer.Serialize(Localizer["Bookmark_Error_Load"].Value, jsonOptions)),
                    errorSave: @Html.Raw(JsonSerializer.Serialize(Localizer["Bookmark_Error_Save"].Value, jsonOptions)),
                    errorDelete: @Html.Raw(JsonSerializer.Serialize(Localizer["Bookmark_Error_Delete"].Value, jsonOptions)),
                    login: @Html.Raw(JsonSerializer.Serialize(Localizer["Bookmark_Login"].Value, jsonOptions))
                }
            };

            window.bookmarksUi?.init(bookmarkConfig);
        })();
    </script>
}

<article class="space-y-10">
    <header class="space-y-3">
        <h1 class="text-3xl font-semibold text-slate-900 dark:text-white">@Model.Title</h1>
        <p class="text-sm text-slate-500 dark:text-slate-300">
            @Localizer["Meta_Id"]: @Model.Id • @Localizer["Meta_Created"]: @FormatDate(Model.CreatedAtUtc) • @Localizer["Meta_Updated"]: @FormatDate(Model.UpdatedAtUtc)
        </p>
        @if (Model.Published)
        {
            <p class="text-sm font-semibold text-emerald-600 dark:text-emerald-300">@Localizer["Status_Published"]</p>
        }
        else
        {
            <p class="text-sm font-semibold text-amber-600 dark:text-amber-300">@Localizer["Status_Draft"]</p>
        }
        <div class="flex flex-wrap gap-2">
            <button id="bookmark-trigger" type="button" class="inline-flex items-center gap-2 rounded-full border border-slate-200 px-3 py-1 text-xs font-semibold uppercase tracking-wide text-slate-700 transition hover:border-emerald-400 hover:text-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 dark:border-slate-700 dark:text-slate-200 dark:hover:border-emerald-500 dark:hover:text-emerald-300">
                <span aria-hidden="true">★</span>
                <span>@Localizer["Bookmark_Button_Save"]</span>
            </button>
        </div>
    </header>

    @if (Model.TitleImageAttachmentId.HasValue)
    {
        <figure class="space-y-2">
            <img src="/attachments/@Model.TitleImageAttachmentId" alt="@Model.Title" class="w-full rounded-xl object-cover" />
        </figure>
    }

    @if (sections.Count == 0)
    {
        <p class="text-sm text-slate-600 dark:text-slate-300">@Localizer["Content_Empty"]</p>
    }
    else
    {
        foreach (var section in sections)
        {
            var items = section.Items ?? new List<TutorialSectionItemDto>();
            var sectionTitle = string.IsNullOrWhiteSpace(section.Title)
                ? Localizer["Content_Section_Fallback", string.Empty].Value?.Trim()
                : section.Title;
            <section class="space-y-4">
                <h2 class="text-2xl font-semibold text-slate-900 dark:text-white">@(string.IsNullOrWhiteSpace(sectionTitle) ? Localizer["Content_Title"] : sectionTitle)</h2>

                @if (items.Count == 0)
                {
                    <p class="text-sm text-slate-600 dark:text-slate-300">@Localizer["Content_Section_Empty"]</p>
                }
                else
                {
                    <div class="space-y-4">
                        @foreach (var item in items)
                        {
                            var type = NormalizeType(item.Type);
                            if (type == "header")
                            {
                                <h3 class="text-xl font-semibold text-slate-900 dark:text-white">@item.Text</h3>
                            }
                            else if (type == "image")
                            {
                                <figure class="space-y-2">
                                    @if (item.AttachmentId.HasValue)
                                    {
                                        <img src="/attachments/@item.AttachmentId" alt="@item.Alt" class="w-full rounded-lg object-cover" />
                                    }
                                    @if (!string.IsNullOrWhiteSpace(item.Caption))
                                    {
                                        <figcaption class="text-sm text-slate-500 dark:text-slate-400">@item.Caption</figcaption>
                                    }
                                </figure>
                            }
                            else if (type == "step")
                            {
                                var steps = item.Steps ?? new List<TutorialStepDto>();
                                if (steps.Count == 0)
                                {
                                    <div class="space-y-2">
                                        @RenderRichText(item.Text)
                                        @RenderPaintList(item.PaintIds, item.Text)
                                    </div>
                                }
                                else
                                {
                                    <ol class="space-y-3 list-decimal pl-5 text-slate-800 dark:text-slate-100">
                                        @for (var i = 0; i < steps.Count; i++)
                                        {
                                            var step = steps[i];
                                            <li class="space-y-1">
                                                @if (!string.IsNullOrWhiteSpace(step.Title))
                                                {
                                                    <p class="font-semibold">@step.Title</p>
                                                }
                                                @RenderRichText(step.Text)
                                                @RenderPaintList(step.PaintIds, step.Text)
                                            </li>
                                        }
                                    </ol>
                                }
                            }
                            else
                            {
                                <div class="space-y-2">
                                    @RenderRichText(item.Text)
                                    @RenderPaintList(item.PaintIds, item.Text)
                                </div>
                            }
                        }
                    </div>
                }
            </section>
        }
    }

    <div id="bookmark-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900/40 p-4">
        <div class="w-full max-w-lg rounded-2xl bg-white p-6 shadow-xl dark:bg-slate-900">
            <div class="space-y-1">
                <p class="text-lg font-semibold text-slate-900 dark:text-white">@Localizer["Bookmark_Title"]</p>
                <p class="text-sm text-slate-500 dark:text-slate-300">@Localizer["Bookmark_Subtitle"]</p>
            </div>

            <div class="mt-5 space-y-4">
                <div class="space-y-1">
                    <label for="bookmark-category" class="text-sm font-semibold text-slate-700 dark:text-slate-200">@Localizer["Bookmark_Category_Label"]</label>
                    <select id="bookmark-category" class="w-full rounded-xl border border-slate-300 bg-white/90 p-3 text-sm text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/40 dark:border-slate-700 dark:bg-slate-950/50 dark:text-slate-100"></select>
                </div>

                <div class="space-y-2">
                    <label for="bookmark-new-category" class="text-sm font-semibold text-slate-700 dark:text-slate-200">@Localizer["Bookmark_NewCategory_Label"]</label>
                    <div class="flex flex-col gap-2 sm:flex-row">
                        <input id="bookmark-new-category" type="text" maxlength="80" placeholder="@Localizer["Bookmark_NewCategory_Placeholder"]" class="w-full rounded-xl border border-slate-300 bg-white/90 p-3 text-sm text-slate-900 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/40 dark:border-slate-700 dark:bg-slate-950/50 dark:text-slate-100" />
                        <button id="bookmark-add-category" type="button" class="inline-flex items-center justify-center rounded-xl border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-emerald-500 hover:text-emerald-600 focus:outline-none focus:ring-2 focus:ring-emerald-400 dark:border-slate-700 dark:text-slate-200 dark:hover:border-emerald-500 dark:hover:text-emerald-300">@Localizer["Bookmark_AddCategory_Button"]</button>
                    </div>
                </div>

                <div class="space-y-1">
                    <label for="bookmark-note" class="text-sm font-semibold text-slate-700 dark:text-slate-200">@Localizer["Bookmark_Note_Label"]</label>
                    <textarea id="bookmark-note" rows="3" placeholder="@Localizer["Bookmark_Note_Placeholder"]" class="w-full rounded-xl border border-slate-300 bg-white/80 p-3 text-sm text-slate-900 placeholder:text-slate-400 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/40 dark:border-slate-700 dark:bg-slate-950/40 dark:text-slate-100"></textarea>
                </div>

                <div id="bookmark-status" class="hidden text-sm font-semibold text-emerald-600 dark:text-emerald-300"></div>
                <div id="bookmark-error" class="hidden text-sm font-semibold text-rose-600 dark:text-rose-300"></div>

                <div class="flex flex-wrap justify-end gap-2">
                    <button id="bookmark-remove" type="button" class="rounded-xl border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-rose-400 hover:text-rose-600 focus:outline-none focus:ring-2 focus:ring-rose-300 dark:border-slate-700 dark:text-slate-200 dark:hover:border-rose-400 dark:hover:text-rose-300">@Localizer["Bookmark_Remove"]</button>
                    <button id="bookmark-cancel" type="button" class="rounded-xl border border-slate-300 px-4 py-2 text-sm font-semibold text-slate-700 transition hover:border-slate-400 focus:outline-none focus:ring-2 focus:ring-slate-300 dark:border-slate-700 dark:text-slate-200 dark:hover:border-slate-500">@Localizer["Bookmark_Cancel"]</button>
                    <button id="bookmark-save" type="button" class="rounded-xl bg-emerald-600 px-4 py-2 text-sm font-semibold text-white transition hover:bg-emerald-700 focus:outline-none focus:ring-2 focus:ring-emerald-400">@Localizer["Bookmark_Save"]</button>
                </div>
            </div>
        </div>
    </div>

    <div class="flex gap-4">
        <a href="@Url.Action("Edit", "Tutorials", new { id = Model.Id })" class="text-sm font-semibold text-amber-700 hover:text-amber-800 dark:text-amber-300 dark:hover:text-amber-200">
            @Localizer["Action_Edit"]
        </a>
        <a href="@Url.Action("Index", "Tutorials")" class="text-sm font-semibold text-slate-700 hover:text-slate-900 dark:text-slate-200 dark:hover:text-white">
            @Localizer["Action_Back"]
        </a>
    </div>
</article>

@functions {
    private static string FormatDate(DateTime? date)
    {
        return date.HasValue ? date.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm") : "–";
    }

    private static string NormalizeType(string? type)
    {
        return string.IsNullOrWhiteSpace(type) ? "text" : type.ToLowerInvariant();
    }

    private static IHtmlContent RenderRichText(string? text)
    {
        if (string.IsNullOrWhiteSpace(text))
        {
            return new HtmlString("<p class=\"text-xs text-slate-500 dark:text-slate-400\">–</p>");
        }

        var encoded = WebUtility.HtmlEncode(text);
        var withPaintBadges = Regex.Replace(encoded, "\\{\\{paint:(\\d+)\\}\\}", match => BuildPaintBadge(match.Groups[1].Value));
        var withBreaks = withPaintBadges.Replace("\n", "<br />");
        return new HtmlString($"<p class=\"leading-relaxed text-slate-800 dark:text-slate-100\">{withBreaks}</p>");
    }

    private static IHtmlContent RenderPaintList(IEnumerable<int>? explicitIds, params string?[] textSources)
    {
        var paints = CollectPaintIds(explicitIds, textSources).ToList();
        if (paints.Count == 0)
        {
            return HtmlString.Empty;
        }

        var badges = string.Join("", paints.Select(id => BuildPaintBadge(id.ToString())));
        return new HtmlString($"<div class=\"flex flex-wrap gap-2 text-xs\">{badges}</div>");
    }

    private static IEnumerable<int> CollectPaintIds(IEnumerable<int>? explicitIds, params string?[] textSources)
    {
        var inlineIds = ExtractPaintIdsFromText(textSources);
        var result = new List<int>();
        var added = new HashSet<int>(inlineIds);

        foreach (var id in explicitIds?.Where(id => id > 0) ?? Enumerable.Empty<int>())
        {
            if (added.Add(id))
            {
                result.Add(id);
            }
        }

        result.Sort();
        return result;
    }

    private static IEnumerable<int> ExtractPaintIdsFromText(IEnumerable<string?> textSources)
    {
        var regex = new Regex("\\{\\{paint:(\\d+)\\}\\}");
        var ids = new HashSet<int>();

        foreach (var text in textSources ?? Enumerable.Empty<string?>())
        {
            if (string.IsNullOrWhiteSpace(text))
            {
                continue;
            }

            foreach (Match match in regex.Matches(text))
            {
                if (int.TryParse(match.Groups[1].Value, out var id))
                {
                    ids.Add(id);
                }
            }
        }

        return ids;
    }

    private static string BuildPaintBadge(string id)
    {
        return $"<span class=\"paint-badge inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white/80 px-3 py-1 text-xs font-semibold text-slate-800 shadow-sm dark:border-slate-700 dark:bg-slate-900/50 dark:text-slate-200\" data-paint-badge data-paint-id=\"{id}\"><span class=\"h-4 w-4 rounded-full border border-white/50 bg-slate-600 shadow-inner dark:border-slate-800\"></span><span class=\"paint-badge__name\">Paint #{id}</span><span class=\"paint-badge__meta text-[10px] font-semibold uppercase tracking-wide text-emerald-600 dark:text-emerald-300\">#{id}</span></span>";
    }
}
