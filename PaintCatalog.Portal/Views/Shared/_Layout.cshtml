@using System.Globalization
@using PaintCatalog.Portal.Helpers
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer LayoutLocalizer

@{
    var uiLang = CultureHelpers.GetCurrentLangTwoLetter();
    var isPl = CultureHelpers.IsPl();
    var currentCultureSegment = CultureHelpers.GetRouteCultureSegment();

    var path = Context.Request.Path.HasValue ? Context.Request.Path.Value : "/";
    var queryString = Context.Request.QueryString.HasValue ? Context.Request.QueryString.Value : string.Empty;
    var host = $"{Context.Request.Scheme}://{Context.Request.Host}";
    var canonicalUrl = host + path;

    var baseLanguageEnUrl = Url.Action(action: null, controller: null, values: new { culture = (string?)null }) ?? path;
    var baseLanguagePlUrl = Url.Action(action: null, controller: null, values: new { culture = "pl" }) ?? path;
    var languageEnUrl = string.IsNullOrEmpty(queryString) ? baseLanguageEnUrl : baseLanguageEnUrl + queryString;
    var languagePlUrl = string.IsNullOrEmpty(queryString) ? baseLanguagePlUrl : baseLanguagePlUrl + queryString;

    var navHomeUrl = Url.Action("Index", "Home", new { culture = currentCultureSegment }) ?? "/";
    var navPaintsUrl = Url.Action("Index", "paints", new { culture = currentCultureSegment }) ?? "/paints";

    var pageTitle = ViewData["Title"]?.ToString();
    var metaDescription = ViewData["MetaDescription"]?.ToString();

    var resolvedTitle = string.IsNullOrWhiteSpace(pageTitle)
        ? LayoutLocalizer["SiteTitle"].Value
        : pageTitle;

    var resolvedDescription = string.IsNullOrWhiteSpace(metaDescription)
        ? LayoutLocalizer["Default_MetaDescription"].Value
        : metaDescription;
}

<!DOCTYPE html>
<html lang="@uiLang" class="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>@resolvedTitle</title>
    <meta name="description" content="@resolvedDescription" />

    <!-- Canonical -->
    <link rel="canonical" href="@canonicalUrl" />

    <!-- Hreflang -->
    <link rel="alternate" href="@($"{host}/")" hreflang="en" />
    <link rel="alternate" href="@($"{host}/pl")" hreflang="pl" />
    <link rel="alternate" href="@canonicalUrl" hreflang="x-default" />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        };
    </script>

    <script>
        function updateThemeIcon(isDark) {
            const icon = document.getElementById('theme-icon');
            if (!icon) {
                return;
            }

            icon.innerHTML = isDark
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-white-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="4" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 2.25v1.5m0 16.5v1.5m9-9h-1.5M4.5 12H3m16.364 6.364-1.06-1.06M6.696 6.696 5.636 5.636m12.728 0-1.06 1.06M6.696 17.304l-1.06 1.06" /></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-700 dark:text-slate-200" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" /></svg>`;
        }

        // Initialize dark/light mode from localStorage or prefers-color-scheme
        (function () {
            const stored = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const shouldUseDark = stored === 'dark' || (!stored && prefersDark);

            if (shouldUseDark) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }

            window.addEventListener('DOMContentLoaded', function () {
                updateThemeIcon(shouldUseDark);
            });
        })();

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }
    </script>
</head>
<body class="bg-white text-slate-900 transition-colors duration-200 dark:bg-slate-950 dark:text-slate-50">
    <header class="sticky top-0 z-20 border-b border-slate-200/60 bg-white/80 backdrop-blur dark:border-slate-800 dark:bg-slate-950/80">
        <div class="mx-auto max-w-6xl px-4 py-3">
            <div class="flex flex-col gap-3">
                <div class="flex items-center justify-between gap-4">
                    <a href="@navHomeUrl" class="flex items-center gap-2">
                        <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-500 text-sm font-bold text-slate-950">PC</span>
                        <span class="text-sm font-semibold tracking-tight text-slate-800 dark:text-slate-50 md:text-base">
                            @LayoutLocalizer["SiteTitle"]
                        </span>
                    </a>

                    <div class="flex items-center gap-2 text-xs">
                        <button onclick="toggleTheme()"
                                class="rounded-full border border-slate-300 p-2 text-slate-700 transition dark:hover:border-emerald-500 hover:border-emerald-500 hover:text-emerald-600 dark:border-slate-700 dark:text-slate-200"
                                aria-label="@LayoutLocalizer["ThemeToggle_Label"]">
                            <span class="sr-only">@LayoutLocalizer["ThemeToggle_Label"]</span>
                            <span id="theme-icon" aria-hidden="true">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-700 dark:text-slate-200" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0 1 18 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 0 0 3 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 0 0 9.002-5.998Z" />
                                </svg>
                            </span>
                        </button>

                        <div class="flex gap-1 rounded-full border border-slate-300 bg-white/80 p-1 dark:border-slate-700 dark:bg-slate-900/80">
                            <a href="@languageEnUrl"
                               class="rounded-full px-2 py-0.5 @(isPl ? "text-slate-500 dark:text-slate-300" : "bg-emerald-500 text-slate-950")">
                                EN
                            </a>
                            <a href="@languagePlUrl"
                               class="rounded-full px-2 py-0.5 @(isPl ? "bg-emerald-500 text-slate-950" : "text-slate-500 dark:text-slate-300")">
                                PL
                            </a>
                        </div>

                        <button type="button" class="md:hidden" onclick="toggleMobileMenu()" aria-label="Toggle navigation">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-800 dark:text-slate-100" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                            </svg>
                        </button>
                    </div>
                </div>

                <nav class="hidden w-full items-center gap-6 text-sm text-slate-600 dark:text-slate-300 md:flex">
                    <a href="@navHomeUrl" class="hover:text-emerald-600 dark:hover:text-emerald-300">@LayoutLocalizer["Nav_Home"]</a>
                    <a href="@navPaintsUrl" class="hover:text-emerald-600 dark:hover:text-emerald-300">@LayoutLocalizer["Nav_Paints"]</a>
                </nav>
            </div>
        </div>

        <div id="mobile-menu" class="hidden border-t border-slate-200 bg-white py-3 text-sm text-slate-700 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 md:hidden">
            <div class="mx-auto max-w-6xl px-4">
                <a href="@navHomeUrl" class="block py-1 hover:text-emerald-600 dark:hover:text-emerald-300">@LayoutLocalizer["Nav_Home"]</a>
                <a href="@navPaintsUrl" class="block py-1 hover:text-emerald-600 dark:hover:text-emerald-300">@LayoutLocalizer["Nav_Paints"]</a>
            </div>
        </div>
    </header>

    <main class="mx-auto max-w-6xl px-4 py-8">
        @RenderBody()
    </main>

    <footer class="border-t border-slate-200 bg-white/90 text-slate-600 dark:border-slate-800 dark:bg-slate-950/90 dark:text-slate-400">
        <div class="mx-auto flex max-w-6xl flex-col justify-between gap-3 px-4 py-4 text-xs md:flex-row">
            <p>Â© @DateTime.UtcNow.Year Paint Catalog Portal</p>
            <div class="flex flex-wrap gap-3">
                <a href="#" class="hover:text-emerald-600 dark:hover:text-emerald-300">@LayoutLocalizer["Footer_About"]</a>
                <a href="#" class="hover:text-emerald-600 dark:hover:text-emerald-300">@LayoutLocalizer["Footer_Contact"]</a>
            </div>
        </div>
    </footer>

    @RenderSection("Scripts", required: false)
</body>
</html>
