@using System.Globalization
@using PaintCatalog.Portal.Helpers
@inject Microsoft.AspNetCore.Mvc.Localization.IViewLocalizer LayoutLocalizer

@{
    // Source of truth: CurrentUICulture set by RequestLocalization middleware
    var uiLang = CultureHelpers.GetCurrentLangTwoLetter();
    var routeCulture = Context.Request.RouteValues["culture"] as string;
    if (string.IsNullOrEmpty(routeCulture) && CultureHelpers.IsPl())
    {
        routeCulture = "pl";
    }

    var isPl = string.Equals(routeCulture, "pl", StringComparison.OrdinalIgnoreCase);

    // canonical path is already normalized (no trailing slash) by middleware
    var path = Context.Request.Path.HasValue ? Context.Request.Path.Value : "/";
    var host = $"{Context.Request.Scheme}://{Context.Request.Host}";
    var canonicalUrl = host + path;

    var homeEnUrl = Url.Action("Index", "Home", new { culture = (string?)null }) ?? "/";
    var homePlUrl = Url.Action("Index", "Home", new { culture = "pl" }) ?? "/pl";
    var paintsEnUrl = Url.Action("Index", "Paints", new { culture = (string?)null }) ?? "/Paints";
    var paintsPlUrl = Url.Action("Index", "Paints", new { culture = "pl" }) ?? "/pl/paints";

    var navHomeUrl = routeCulture == "pl" ? homePlUrl : homeEnUrl;
    var navPaintsUrl = routeCulture == "pl" ? paintsPlUrl : paintsEnUrl;

    var pageTitle = ViewData["Title"]?.ToString();
    var metaDescription = ViewData["MetaDescription"]?.ToString();

    var resolvedTitle = string.IsNullOrWhiteSpace(pageTitle)
        ? LayoutLocalizer["SiteTitle"].Value
        : pageTitle;

    var resolvedDescription = string.IsNullOrWhiteSpace(metaDescription)
        ? LayoutLocalizer["Default_MetaDescription"].Value
        : metaDescription;
}

<!DOCTYPE html>
<html lang="@uiLang" class="dark">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>@resolvedTitle</title>
    <meta name="description" content="@resolvedDescription" />

    <!-- Canonical -->
    <link rel="canonical" href="@canonicalUrl" />

    <!-- Hreflang -->
    <link rel="alternate" href="@($"{host}/")" hreflang="en" />
    <link rel="alternate" href="@($"{host}/pl")" hreflang="pl" />
    <link rel="alternate" href="@canonicalUrl" hreflang="x-default" />

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class'
        };
    </script>

    <script>
        // Initialize dark/light mode from localStorage or prefers-color-scheme
        (function () {
            const stored = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;

            if (stored === 'dark' || (!stored && prefersDark)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        })();

        function toggleTheme() {
            const html = document.documentElement;
            const isDark = html.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobile-menu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }
    </script>
</head>
<body class="bg-white text-slate-900 transition-colors duration-200 dark:bg-slate-950 dark:text-slate-50">
    <header class="sticky top-0 z-20 border-b border-slate-200/60 bg-white/80 backdrop-blur dark:border-slate-800 dark:bg-slate-950/80">
        <div class="mx-auto flex max-w-6xl items-center justify-between px-4 py-3">
            <a href="@navHomeUrl" class="flex items-center gap-2">
                <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-emerald-500 text-sm font-bold text-slate-950">PC</span>
                <span class="text-sm font-semibold tracking-tight text-slate-800 dark:text-slate-50 md:text-base">
                    @LayoutLocalizer["SiteTitle"]
                </span>
            </a>

            <nav class="hidden items-center gap-6 text-sm text-slate-600 dark:text-slate-300 md:flex">
                <a href="@navHomeUrl" class="hover:text-emerald-600 dark:hover:text-emerald-300">@LayoutLocalizer["Nav_Home"]</a>
                <a href="@navPaintsUrl" class="hover:text-emerald-600 dark:hover:text-emerald-300">@LayoutLocalizer["Nav_Paints"]</a>
            </nav>

            <div class="flex items-center gap-2 text-xs">
                <button onclick="toggleTheme()"
                        class="rounded-full border border-slate-300 px-3 py-1 text-slate-700 transition hover:border-emerald-500 hover:text-emerald-600 dark:border-slate-700 dark:text-slate-200">
                    @LayoutLocalizer["ThemeToggle_Label"]
                </button>

                <div class="flex gap-1 rounded-full border border-slate-300 bg-white/80 p-1 dark:border-slate-700 dark:bg-slate-900/80">
                    <a href="@homeEnUrl"
                       class="rounded-full px-2 py-0.5 @(isPl ? "text-slate-500 dark:text-slate-300" : "bg-emerald-500 text-slate-950")">
                        EN
                    </a>
                    <a href="@homePlUrl"
                       class="rounded-full px-2 py-0.5 @(isPl ? "bg-emerald-500 text-slate-950" : "text-slate-500 dark:text-slate-300")">
                        PL
                    </a>
                </div>

                <button type="button" class="md:hidden" onclick="toggleMobileMenu()" aria-label="Toggle navigation">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-slate-800 dark:text-slate-100" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                    </svg>
                </button>
            </div>
        </div>

        <div id="mobile-menu" class="hidden border-t border-slate-200 bg-white px-4 py-3 text-sm text-slate-700 dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200 md:hidden">
            <a href="@navHomeUrl" class="block py-1 hover:text-emerald-600 dark:hover:text-emerald-300">@LayoutLocalizer["Nav_Home"]</a>
            <a href="@navPaintsUrl" class="block py-1 hover:text-emerald-600 dark:hover:text-emerald-300">@LayoutLocalizer["Nav_Paints"]</a>
        </div>
    </header>

    <main class="mx-auto max-w-6xl px-4 py-8">
        @RenderBody()
    </main>

    <footer class="border-t border-slate-200 bg-white/90 text-slate-600 dark:border-slate-800 dark:bg-slate-950/90 dark:text-slate-400">
        <div class="mx-auto flex max-w-6xl flex-col justify-between gap-3 px-4 py-4 text-xs md:flex-row">
            <p>Â© @DateTime.UtcNow.Year Paint Catalog Portal</p>
            <div class="flex flex-wrap gap-3">
                <a href="#" class="hover:text-emerald-600 dark:hover:text-emerald-300">@LayoutLocalizer["Footer_About"]</a>
                <a href="#" class="hover:text-emerald-600 dark:hover:text-emerald-300">@LayoutLocalizer["Footer_Contact"]</a>
            </div>
        </div>
    </footer>

    @RenderSection("Scripts", required: false)
</body>
</html>
