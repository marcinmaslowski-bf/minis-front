(function (global) {
    function createButton(label, title) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'ql-btn';
        button.title = title || label;
        button.innerHTML = label;
        return button;
    }

    class Quill {
        constructor(element, options) {
            if (!element) {
                throw new Error('Quill requires a container element.');
            }

            this.container = element;
            this.options = options || {};
            this.handlers = { 'text-change': [] };

            this.toolbar = document.createElement('div');
            this.toolbar.className = 'ql-toolbar ql-snow';

            this.root = document.createElement('div');
            this.root.className = 'ql-editor';
            this.root.setAttribute('contenteditable', 'true');

            this.container.classList.add('ql-container', 'ql-snow');
            this.container.appendChild(this.toolbar);
            this.container.appendChild(this.root);

            this._buildToolbar((options?.modules?.toolbar) || []);

            this.root.addEventListener('input', () => this._emit('text-change'));
            this.root.addEventListener('blur', () => this._emit('text-change'));
        }

        _buildToolbar(config) {
            config.forEach(group => {
                const groupEl = document.createElement('span');
                groupEl.className = 'ql-formats';

                group.forEach(control => {
                    if (typeof control === 'string') {
                        const button = createButton(control.charAt(0).toUpperCase(), control);
                        button.dataset.format = control;
                        button.addEventListener('click', () => this._format(control));
                        groupEl.appendChild(button);
                        return;
                    }

                    if (typeof control === 'object' && control.list) {
                        const type = control.list;
                        const label = type === 'ordered' ? '1.' : 'â€¢';
                        const button = createButton(label, `${type} list`);
                        button.dataset.format = `list-${type}`;
                        button.addEventListener('click', () => this._format('list', type));
                        groupEl.appendChild(button);
                    }
                });

                this.toolbar.appendChild(groupEl);
            });
        }

        _format(type, value) {
            this.focus();
            switch (type) {
                case 'bold':
                    document.execCommand('bold');
                    break;
                case 'italic':
                    document.execCommand('italic');
                    break;
                case 'underline':
                    document.execCommand('underline');
                    break;
                case 'link': {
                    const url = prompt('Enter link URL');
                    if (url) {
                        document.execCommand('createLink', false, url);
                    }
                    break;
                }
                case 'list':
                    if (value === 'bullet') {
                        document.execCommand('insertUnorderedList');
                    } else {
                        document.execCommand('insertOrderedList');
                    }
                    break;
                default:
                    break;
            }
            this._emit('text-change');
        }

        on(event, handler) {
            if (!this.handlers[event]) {
                this.handlers[event] = [];
            }
            this.handlers[event].push(handler);
        }

        _emit(event) {
            (this.handlers[event] || []).forEach(handler => handler());
        }

        focus() {
            this.root.focus();
        }

        insertText(text) {
            this.focus();
            if (typeof document.execCommand === 'function') {
                document.execCommand('insertText', false, text);
            } else {
                this.root.appendChild(document.createTextNode(text));
            }
            this._emit('text-change');
        }
    }

    global.Quill = Quill;
})(window);
