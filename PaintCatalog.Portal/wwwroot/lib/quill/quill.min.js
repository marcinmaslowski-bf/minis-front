(function (global) {
    function createButton(label, title) {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'ql-btn';
        button.title = title || label;
        button.innerHTML = label;
        return button;
    }

    class Quill {
        constructor(element, options) {
            if (!element) {
                throw new Error('Quill requires a container element.');
            }

            this.container = element;
            this.options = options || {};
            this.handlers = { 'text-change': [] };
            this.customHandlers = options?.modules?.handlers || {};
            this.clipboard = {
                dangerouslyPasteHTML: (index, html) => this._pasteHTML(index, html)
            };

            this.toolbar = document.createElement('div');
            this.toolbar.className = 'ql-toolbar ql-snow';

            this.root = document.createElement('div');
            this.root.className = 'ql-editor';
            this.root.setAttribute('contenteditable', 'true');

            this.container.classList.add('ql-container', 'ql-snow');
            this.container.appendChild(this.toolbar);
            this.container.appendChild(this.root);

            this._buildToolbar((options?.modules?.toolbar) || []);

            this.root.addEventListener('input', () => this._emit('text-change'));
            this.root.addEventListener('blur', () => this._emit('text-change'));

            document.addEventListener('selectionchange', () => {
                const selection = this.getSelection();
                if (selection) {
                    this._emit('selection-change', selection);
                }
            });
        }

        _buildToolbar(config) {
            const groups = Array.isArray(config) ? config : (Array.isArray(config?.container) ? config.container : []);
            groups.forEach(group => {
                const groupEl = document.createElement('span');
                groupEl.className = 'ql-formats';

                (group || []).forEach(control => {
                    if (typeof control === 'string') {
                        const button = createButton(control.charAt(0).toUpperCase(), control);
                        button.dataset.format = control;
                        button.addEventListener('click', () => this._handleFormat(control));
                        groupEl.appendChild(button);
                        return;
                    }

                    if (typeof control === 'object' && control.list) {
                        const type = control.list;
                        const label = type === 'ordered' ? '1.' : 'â€¢';
                        const button = createButton(label, `${type} list`);
                        button.dataset.format = `list-${type}`;
                        button.addEventListener('click', () => this._handleFormat('list', type));
                        groupEl.appendChild(button);
                    }
                });

                this.toolbar.appendChild(groupEl);
            });
        }

        addHandler(format, handler) {
            this.customHandlers[format] = handler;
        }

        _handleFormat(type, value) {
            const customHandler = this.customHandlers[type];
            if (typeof customHandler === 'function') {
                customHandler(value);
                this._emit('text-change');
                return;
            }
            this._format(type, value);
        }

        _format(type, value) {
            this.focus();
            switch (type) {
                case 'bold':
                    document.execCommand('bold');
                    break;
                case 'italic':
                    document.execCommand('italic');
                    break;
                case 'underline':
                    document.execCommand('underline');
                    break;
                case 'link': {
                    const url = prompt('Enter link URL');
                    if (url) {
                        document.execCommand('createLink', false, url);
                    }
                    break;
                }
                case 'list':
                    if (value === 'bullet') {
                        document.execCommand('insertUnorderedList');
                    } else {
                        document.execCommand('insertOrderedList');
                    }
                    break;
                default:
                    break;
            }
            this._emit('text-change');
        }

        on(event, handler) {
            if (!this.handlers[event]) {
                this.handlers[event] = [];
            }
            this.handlers[event].push(handler);
        }

        _emit(event, ...args) {
            (this.handlers[event] || []).forEach(handler => handler(...args));
        }

        _findPosition(index) {
            const walker = document.createTreeWalker(this.root, NodeFilter.SHOW_TEXT, null);
            let node = walker.nextNode();
            let remaining = Math.max(0, index);

            while (node && remaining > node.textContent.length) {
                remaining -= node.textContent.length;
                node = walker.nextNode();
            }

            if (!node) {
                return { node: this.root, offset: this.root.childNodes.length };
            }

            return { node, offset: Math.min(remaining, node.textContent.length) };
        }

        getLength() {
            return this.root?.innerText?.length ?? 0;
        }

        getSelection() {
            const selection = window.getSelection();
            if (!selection || selection.rangeCount === 0) {
                return null;
            }

            const range = selection.getRangeAt(0);
            if (!this.root.contains(range.commonAncestorContainer)) {
                return null;
            }

            const preRange = range.cloneRange();
            preRange.selectNodeContents(this.root);
            preRange.setEnd(range.startContainer, range.startOffset);

            const index = preRange.toString().length;
            const length = range.toString().length;
            return { index, length };
        }

        setSelection(index, length = 0) {
            this.focus();

            const start = this._findPosition(index);
            const end = this._findPosition(index + length);

            const range = document.createRange();
            range.setStart(start.node, start.offset);
            range.setEnd(end.node, end.offset);

            const selection = window.getSelection();
            if (selection) {
                selection.removeAllRanges();
                selection.addRange(range);
            }

            this._emit('selection-change', { index, length });
        }

        focus() {
            this.root.focus();
        }

        insertText(text) {
            this.focus();
            if (typeof document.execCommand === 'function') {
                document.execCommand('insertText', false, text);
            } else {
                this.root.appendChild(document.createTextNode(text));
            }
            this._emit('text-change');
        }

        _pasteHTML(index, html) {
            const range = document.createRange();
            const position = this._findPosition(index);

            range.setStart(position.node, position.offset);
            range.collapse(true);

            const fragment = range.createContextualFragment(html);
            range.insertNode(fragment);

            range.collapse(false);
            const selection = window.getSelection();
            if (selection) {
                selection.removeAllRanges();
                selection.addRange(range);
            }

            this._emit('text-change');
        }
    }

    global.Quill = Quill;
})(window);
